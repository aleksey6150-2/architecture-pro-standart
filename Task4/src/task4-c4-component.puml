@startuml C4_Components_Rate_Integration
!include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Component.puml

LAYOUT_WITH_LEGEND()
LAYOUT_TOP_DOWN()

' === ГРАНИЦА RATE MANAGEMENT SERVICE ===
Boundary(rate_service, "Rate Management Service", "Java Spring Boot") {

    Component(rate_api, "Rate API", "REST Controller", "CRUD операций со ставками\nВерсионирование\nПагинация")
    Component(rate_service_logic, "Rate Service", "Business Logic", "Бизнес-правила\nВалидация\nРасчет персональных ставок")
    Component(rate_repo, "Rate Repository", "Spring Data JPA", "Доступ к БД ставок")
    ComponentDb(rate_db, "Rate Database", "Oracle", "Таблицы:\nproducts, rates,\nrate_history")

    Component(cache_service, "Cache Service", "Redis Client", "Кэширование ставок\nИнвалидация при изменениях")
    ComponentDb(redis, "Redis Cache", "Cluster", "TTL: 5-15 минут")
}

' === ГРАНИЦА RATE PUBLISHER MODULE ===
Boundary(publisher, "Rate Publisher Module", "Java Spring Boot") {

    Component(publisher_api, "Publisher API", "REST Controller", "Ручной запуск экспорта\nНастройка расписания\nПросмотр истории")
    Component(scheduler, "Export Scheduler", "Spring Scheduler", "Периодический запуск\nCron: 0 */15 * * * ?")
    Component(exporter, "Rate Exporter", "Export Engine", "Формирование файлов\nCSV/XML генерация\nВерсионирование файлов")
    Component(sftp_client, "SFTP Client", "JSch / Apache Commons VFS", "Безопасная передача\nРетраи с эксп. выдержкой")
    Component(audit_service, "Audit Service", "Event Logger", "Логирование экспорта\nСтатусы доставки")
    ComponentDb(publisher_db, "Publisher DB", "PostgreSQL/H2", "История экспорта\nНастройки расписания")
}

' === ВНЕШНИЙ КОЛ-ЦЕНТР ===
Boundary(partner, "Партнерский кол-центр", "Внешняя система") {

    Component(partner_sftp, "SFTP Client", "Автоматический опрос", "Загрузка файлов по расписанию")
    Component(partner_importer, "File Importer", "Batch-процесс", "Парсинг CSV/XML\nВалидация формата")
    ComponentDb(partner_db, "Partner DB", "Oracle/PostgreSQL", "Локальное хранилище ставок")
    Component(partner_ui, "CRM Interface", "UI", "Отображение ставок оператору")
}

' === ВНУТРЕННИЙ КОЛ-ЦЕНТР ===
Boundary(cc, "Система кол-центра", "Java Spring Boot") {

    Component(cc_client, "REST Client", "Feign/WebClient", "Вызов Rate API")
    ComponentDb(cc_cache, "Local Cache", "Caffeine/Ehcache", "Кэширование ставок\nTTL: 5 минут")
    Component(cc_ui, "Operator UI", "React", "Отображение ставок")
}

' === СВЯЗИ ===
Rel(rate_api, rate_service_logic, "Call")
Rel(rate_service_logic, rate_repo, "CRUD")
Rel(rate_repo, rate_db, "JDBC")
Rel(rate_service_logic, cache_service, "Get/Set")
Rel(cache_service, redis, "Redis protocol")

Rel(publisher_api, scheduler, "Configure")
Rel(scheduler, exporter, "Trigger")
Rel(exporter, rate_service_logic, "Get rates", "REST/Feign")
Rel(exporter, sftp_client, "Generate & Send")
Rel(sftp_client, audit_service, "Log result")
Rel(sftp_client, partner_sftp, "SFTP", "port 22")

Rel(partner_sftp, partner_importer, "File received")
Rel(partner_importer, partner_db, "Import")
Rel(partner_db, partner_ui, "Query")

Rel(cc_client, rate_api, "GET /rates", "REST/HTTPS")
Rel(cc_client, cc_cache, "Cache")
Rel(cc_ui, cc_client, "Display")

SHOW_LEGEND()
@enduml